
# Massa-Proto-CLI

This package makes it easy to generate call functions for smart contract methods in TypeScrit and Assembly Script.
The generated functions can be used in your smart contracts as well as in your projects that use typeScript or javaScript.

## Usage

### Install
To get the stable version: `npm i @massalabs/massa-proto-cli @massalabs/massa-web3@1.19.2-dev.20230704134830`.

To get the nightly version: `npm i @massalabs/massa-proto-cli @massalabs/massa-web3@1.19.2-dev.20230704134830`.

To update the nightly version: `npm update @massalabs/massa-proto-cli`.

Install: `npm i as-proto as-proto-gen @massalabs/massa-as-sdk @massalabs/as-types @massalabs/as-transformer` for AS smart contract caller generation.
Install: `npm i @protobuf-ts/plugin` for TS web3 caller generation.

### Use the CLI
First, create a `.env` file in your node project which contains the following variables:
```env
JSON_RPC_URL_PUBLIC=your_node_url
```
You can use either the buildnet:
`https://buildnet.massa.net/api/v2:33035`
or the testnet:
`https://testnet.massa.net/api/v2:33035`
or your own node.


Then, you can run the following command:	
 `npx massa-proto --help`
 or
 `npx massa-proto --addr=the_contract_address --gen=mode --out=outputDirectory`

- `--addr` must be followed by a contract address for which you want to generate your callers.
- `--gen` must be followed by the desired generation mode: `sc` or `web3`. (`sc` for contract to contract caller and `web3` for typeScript to contract generation)
- `--out` must be followed by the path to the folder in which the callers will be generated


### What you need to know
1. Two files are generated for each function: `[functionName]Helper.ts` and `[functionName]Caller.ts`. You only need to use the Caller. ( The Helper's job is to serialize and deserialize the arguments and it is used by the Caller)
2. If you are generating Type Script to contract callers (`web3` mode), you will need to define a callSC method using massa-web3 or wallet-provider depending on what you are using in your project ( It is explained in the documentation of the generated caller )
3. A generic documentation is generated for the caller. You can complete it by describing the purpose of the arguments you are using

### Use the generated callers
We consider a smart contract function: `sum(a: i64, b: i64): i64`
Its corresponding protofile is:
```protobuf
syntax = "proto3";
message sumHelper {
  int64 a = 1;
  int64 b = 2;
}
message sumRHelper {
  int64 value = 1;
}
```
#### Type Script to contract caller
A Smart-Contract caller function for 'sum' looks like:  
```typescript
/**
* This method have been generated by the Massa Proto CLI.
* It allows you to call the "sum" function of the
* "AU1ZccersHqQKm45oNC8y4GQ97t3M6MkUr4kJjgF635xkDbzocP3" Smart Contract.
*
* @remarks
* To work properly, you need to run 'npm install @protobuf-ts/plugin' in your project folder.
* Otherwise, this caller will not work.
*
* @param  {bigint}  a - 
* @param  {bigint}  b -
*
* @returns  {bigint} The result of the "sum" function.
*/
export  async  function  sum(a: bigint, b: bigint, coins: bigint): Promise<bigint> {
// Serialize the arguments
const  serializedArgs = sumHelper.toBinary({a:  a, b:  b});

// Send the operation to the blockchain and retrieve its outputs
return  await  callSC(
'AU1ZccersHqQKm45oNC8y4GQ97t3M6MkUr4kJjgF635xkDbzocP3',
'sum',
serializedArgs,
coins,
);
}
```

You can use the caller like this:
```typescript
import { sum } from "./sumCaller.ts"

// Here we suppose that you have already setup your callSC method in the caller using massa-web3 or the wallet-provider
console.log("a + b = ", sum(a, b));
```

#### Smart Contract to contract caller
/!\ Make sure to set the --out argument to a directory inside "/assembly/contracts/"!
/!\ In the package.json file, on the "build" script add the "-r" option after the compiler command!
These are due to the fact that current smart contract compiler doesn't support local imports unless you build with "npx massa-as-compile -r" which allows
mirroring of the directories in the build files.

A Smart-Contract caller function for 'sum' looks like:  
```typescript
export function sum(a: i64, b: i64,  coins: u64): u64 {

  const result = call(
    new Address("AS12r62avFS7NwXhSCLNjszUBUL7a5RMCmM9XicgdAd5bPRsP4fTF"),
    "sum",
    new Args(changetype<StaticArray<u8>>(encodeeventHelper(new eventHelper(
      a, b
    )))),
    coins
  );

  // Convert the result to the expected response type
  const response = decodeeventRHelper(Uint8Array.wrap(changetype<ArrayBuffer>(result)));

  return response.value;
}
```

You can use the caller like this:
```typescript
import { sum } from "./sumCaller.ts"

// Here we suppose that you have already setup your callSC method in the caller using massa-web3 or the wallet-provider
console.log("a + b = ", sum(a, b));
```

## Contribute

We welcome contributions from the community!

If you would like to contribute to Massa-Proto-cli, please read the [CONTRIBUTING](https://github.com/massalabs/massa-sc-toolkit/blob/main/CONTRIBUTING.md) file.
